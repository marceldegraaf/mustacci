#!/usr/bin/env ruby

require 'zmq'
require './lib/mustacci'
require './lib/mustacci/worker'

QUEUE = "tcp://127.0.0.1:9000"

puts "Listening for builds on #{QUEUE}"

context = ZMQ::Context.new(1)
inbound = context.socket(ZMQ::UPSTREAM)
inbound.bind QUEUE

loop do
  trap('INT') do
    Mustacci.log 'Exit signal received, shutting down...'
    inbound.close
    exit
  end

  data = inbound.recv
  begin
    Mustacci::Worker.new(data).run!
  rescue Exception => error
    $stderr.puts "\e[31m[#{Time.now}] #{error.class}: #{error}\e[0m"
    error.backtrace.each do |line|
      $stderr.puts "      \e[30m#{line}\e[0m"
    end
    inbound.close
    exit 1
  end
end
