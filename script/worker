#!/usr/bin/env ruby

require 'json'
require 'yaml'
require 'zmq'
require 'pty'

QUEUE = "tcp://127.0.0.1:9000"
CONFIG = YAML.load(File.open("repositories.yml"))

def run(data)
  payload = JSON.parse(data)
  repo = payload["repository"]["url"]

  puts "[#{Time.now}] Building #{repo.inspect}"

  path = CONFIG[repo]["path"]

  PTY.spawn "./script/runner #{repo} #{path}" do |read, write, pid|
    read.each_char do |char|
      # TODO send this to a websocket
      print char
    end
  end

end

puts "Listening for builds on #{QUEUE}"

context = ZMQ::Context.new(1)
inbound = context.socket(ZMQ::UPSTREAM)
inbound.bind QUEUE

loop do
  trap('INT') do
    puts 'Exit signal received, shutting down...'
    inbound.close
    exit
  end

  data = inbound.recv
  puts "Received data here!"
  begin
    run data
  rescue Exception => error
    puts error.class
    puts error
    puts *error.backtrace
    exit
  end
end
