#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))

require 'zmq'
require 'mustacci'
require 'mustacci/worker'

QUEUE = "tcp://#{Mustacci.config.zmq.hostname}:#{Mustacci.config.zmq.port}"

puts "Listening for builds on #{QUEUE}"

context = ZMQ::Context.new(1)
inbound = context.socket(ZMQ::UPSTREAM)
inbound.bind QUEUE

loop do
  trap('INT') do
    Mustacci.log 'Exit signal received, shutting down...'
    inbound.close
    exit
  end

  data = inbound.recv
  begin
    Mustacci::Worker.new(data).run!
  rescue Exception => error
    $stderr.puts "\e[31m[#{Time.now}] #{error.class}: #{error}\e[0m"
    error.backtrace.each do |line|
      $stderr.puts "      \e[30m#{line}\e[0m"
    end
    inbound.close
    exit 1
  end
end
